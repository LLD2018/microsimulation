% Rekapitulering av vad vi gjorde

\section{Changes to the original code}
%% "Refactoring of the code" might be a better title?
The computation can be modelled using the MapReduce programming model. After
analysing the code base, the conclusion was to first try to
parallelise using openMP, then extend to MPI.

First, to the map step of the code, we added:
\begin{lstlisting}
#pragma omp parallel shared(nthreads,chunk) private(i,tid,sim,diffTime,cumTime)
...
#pragma omp for schedule(static,1).
\end{lstlisting}
However, the reduce step was not straightforward to parallelise. In
the serial version of the code, the result was accumulated in an
associative array (\texttt{map<,>} in C++ terminology ) with scope
throughout the whole module file (\emph{source file}). After each map
step, the result associative array (from now on denoted \emph{report})
was incrementally updated. In this reduction step several function
calls were made updating the report, where the functions
accessed it in the scope of the file and not by a passed reference. So
in the first naive version, we just added:
\lstset{language=C++}
\begin{lstlisting}
#pragma omp critical
  {
  // updating the result, i.e., ``reduction step''
    report.add(FullState(state, ext_grade,
               dx, psa>=3.0, cohort), msg->kind,
               previousEventTime, now());
  }
\end{lstlisting}

After a performance analysis, we realised that the reduction step as
implemented became the bottle-neck of the whole program. Instead, we
let each thread/process build up its contribution to the end report in
a thread private variable, and then merge these partial results into the
shared report object.

The R software also have a feature of using multiple threads, and we used
that as a benchmark for our implementations.

Summarising the steps, we label them
\begin{enumerate}
\item ``R-side parallelism'' (high level R multithreading)
\item ``naive OpenMP'' (parallelising the map step)
\item ``improved OpenMP'' (first a thread-wise reduction of the output
  from the map step, then
  reducing these partial results into the final result)
\end{enumerate}

% R parallelisation

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "report"
%%% End:
